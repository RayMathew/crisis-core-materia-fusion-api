<!DOCTYPE html>
<html>

<head>
  <title>Crisis Core Materia Fusion API</title>

  <style>
    .copy {
      max-width: 700px;
      font-family: sans-serif;
      margin: 0 auto;
      line-height: 1.5;
    }

    pre {
      background-color: #eee;
      padding: 1em;
      overflow: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    table+table {
      margin-top: 2em;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 0.5em;
      vertical-align: top;
    }

    td:first-child {
      width: 170px;
    }

    td code {
      white-space: nowrap;
    }

    samp {
      color: rgb(110, 110, 110);
    }
  </style>
</head>

<body>
  <div class="copy">

    <h1 id="crisis-core-materia-fusion-api">Crisis Core Materia Fusion API</h1>
    <p>An API based on the game <a href="https://en.wikipedia.org/wiki/Crisis_Core:_Final_Fantasy_VII">Crisis Core:
        Final Fantasy VII</a> for simulating fusion of materia.</p>
    <p>If you want to just try it out, skip to <a href="#getting-started">Getting Started</a>.</p>
    <h2 id="motivation-for-building-this-project">Motivation for building this project</h2>
    <h3 id="the-game-doesn-t-make-it-easy-to-guess-the-fusion-output">The game doesn&#39;t make it easy to guess the
      fusion output</h3>
    <ul>
      <li>The patterns and rules used to determine the fusion output of two materia are surprisingly complex. For example, 
        the output can change if Materia 1 and Materia 2 are interchanged, or if one or both materia are &#39;Mastered&#39;. 
        These complex rules, when applied to 144 distinct materia, lead to over <strong>280,000</strong> possible permutations!
        </li>
      <li>Even trial and error becomes challenging, as you must first obtain the input materia in the game before you can see 
        what the fusion output might be.</li>
    </ul>
    <p>This API seeks to address both these pain points.</p>
    <h3 id="an-excuse-to-learn-a-ton-of-stuff">An excuse to learn a ton of stuff</h3>
    <ul>
      <li>I wanted to learn Go and PostgreSQL. The prospect of building something
        practical, useful AND for one of my favourite game series of all time was way more fun than going through yet
        another YouTube course.</li>
      <li>This will also explain why some of the <a href="#technical-features">features</a> of the API feel like overkill.</li>
      <li>I've written about the journey I went through to and the things I learnt while building this project (link coming soon).</li>
    </ul>
    <h2 id="getting-started">Getting started</h2>
    <ul>
      <li><a href="https://crisis-core-materia-fusion-api-546461677134.us-central1.run.app/docs">OpenAPI
          documentation</a>. Try it out, no authentication required.</li>
      <li>Use the <a href="https://github.com/RayMathew/crisis-core-materia-fusion-api/discussions">Discussions tab</a>
        for questions and comments.</li>
    </ul>
    <h3 id="running-locally">Running locally</h3>
    <p>Assumptions: You already have a PostgreSQL DB up and running. If you want to create a local instance in Mac I
      recommend <a href="https://formulae.brew.sh/formula/postgresql@16#default">Homebrew</a>. If you want to create a
      remote instance, <a href="https://www.cockroachlabs.com/docs/stable/deploy-app-gcr">try this</a>.</p>
    <ol>
      <li>
        <p>After downloading the repo, create a <code>.env</code> file in the root directory with the following keys:
        </p>
        <ul>
          <li>
            <p>HTTP_PORT (recommended value 4444)</p>
          </li>
          <li>
            <p>DB_DSN (format:
              <code>&quot;&lt;username&gt;:&lt;password&gt;@&lt;db_host_url&gt;:&lt;db_port&gt;/&lt;db_name&gt;?sslmode=disabled&quot;</code>).
              It should <strong>not</strong> be prefixed with <code>postgres://</code></p>
          </li>
          <li>
            <p>For DB_DSN, you can also use <code>sslmode=verify-full&amp;sslrootcert=&lt;path_to_cert&gt;.crt</code> if
              connecting to a remote DB.</p>
          </li>
          <li>
            <p>API_TIMEOUT_SECONDS (suggested value 5)</p>
          </li>
          <li>
            <p>API_CALLS_ALLOWED_PER_SECOND (suggested value 1)</p>
          </li>
        </ul>
      </li>
      <li>
        <p>Run:</p>
        <pre><code class="lang-sh"> <span class="hljs-keyword">go</span> <span class="hljs-keyword">mod</span> tidy
 <span class="hljs-keyword">go</span> <span class="hljs-keyword">mod</span> vendor
 <span class="hljs-keyword">make</span> run
</code></pre>
      </li>
      <li>
        <p>Optional: install golangci-lint</p>
        <pre><code class="lang-sh"> go install github.com<span class="hljs-regexp">/golangci/</span>golangci-lint<span class="hljs-regexp">/cmd/</span>golangci-lint<span class="hljs-meta">@latest</span>
</code></pre>
      </li>
    </ol>
    <h3 id="running-locally-with-docker">Running locally - with Docker</h3>
    <p>The Dockerfile is currently being used only for deploying on Cloud Run. To use it locally, do the following:</p>
    <ol>
      <li>Create <code>.env</code> file, just like in above section.</li>
      <li>Add the line <code>COPY .env /app/.env</code> to the Dockerfile to copy your secret environment variables into
        the Docker image.</li>
      <li>
        <p>Run:</p>
        <pre><code class="lang-sh"> <span class="hljs-built_in">make</span> dbuild
 <span class="hljs-built_in">make</span> drun
</code></pre>
      </li>
    </ol>
    <h3 id="testing-locally">Testing locally</h3>
    <ul>
      <li>Use <code>&lt;rootfolder&gt;/api/docs/swagger.json</code> (or the <a
          href="https://crisis-core-materia-fusion-api-546461677134.us-central1.run.app/docs/doc.json">hosted
          version</a>) to import all endpoint definitions into tools like Postman.</li>
    </ul>
    <h2 id="tech-stack">Tech stack</h2>
    <table>
      <tbody>
        <tr>
          <td>Language</td>
          <td>Go</td>
        </tr>
        <tr>
          <td>DB</td>
          <td>PostgreSQL</td>
        </tr>
        <tr>
          <td>Web server platform</td>
          <td><a href="https://cloud.google.com/run?hl=en">Google Run</a></td>
        </tr>
        <tr>
          <td>DB platform</td>
          <td><a href="https://www.cockroachlabs.com/">CockroachDB</a></td>
        </tr>
        <tr>
          <td>Documentation</td>
          <td><a href="https://goswagger.io/go-swagger/">go-swagger</a></td>
        </tr>
      </tbody>
    </table>
    <h2 id="features">Features</h2>
    <ol>
      <li>The brilliant <a href="https://autostrada.dev/">Autostrada.dev</a> was used to generate the project&#39;s
        boilerplate code.</li>
      <li>The API uses an <strong>in-server cache</strong>, since both <code>/materia</code> and <code>/fusion</code>
        endpoints use the same data, and the data is static. So, requests to the DB happen only on server redeployments.
      </li>
      <li>
        <p>The API has middleware for:</p>
        <ul>
          <li>panic recovery</li>
          <li>&#39;Content-Type&#39;checking</li>
          <li>rate limiting</li>
          <li>api timeout protection</li>
        </ul>
      </li>
      <li>
        <p>The inputs for <code>/fusion</code> endpoint have validations for mandatory keys, data types, and materia
          names.</p>
      </li>
      <li>A <code>.golangci.yaml</code> file is available for lint checks in local. Install <a
          href="https://golangci-lint.run/">golanci-lint</a> first.</li>
      <li>A Dockerfile is available for building the API and running as a container. It is currently being used only for
        deploying on Cloud Run. To use locally, see the comments in <code>&lt;rootfolder&gt;/Makefile</code>.</li>
      <li>The code constitutes over <strong>1300 rules</strong> to determine fusion ouputs.</li>
    </ol>
    <h2 id="future-roadmap">Future Roadmap</h2>
    <ol>
      <li>Add more unit tests.</li>
      <li>Create a separate Dockerfile for local builds, and move PostgreSQL setup into it.</li>
      <li>Reduce the setup required for <code>.env</code> file.</li>
      <li>Add <code>.golangci.yaml</code> into the pipeline and fine-tune the individual linter checks. This might incur
        some costs, so it is the least priority for now.</li>
      <li>The big one - create a new endpoint for materia fusion with items.</li>
    </ol>
    <h2 id="thanks">Thanks</h2>
    <p>A huge thanks to the mysterious <a href="https://gamefaqs.gamespot.com/community/ZeoKnight">ZeoKnight</a>, who
      did most of the heavylifting in <a
        href="https://gamefaqs.gamespot.com/psp/925138-crisis-core-final-fantasy-vii/faqs/75088/materia-combination-list">figuring
        out the rules</a> back in 2017. I did end up modifying a few of his rules that were either incorrect or
      incomplete, but it doesn&#39;t take anything away from the brilliance of his work.</p>
    <h2 id="license">License</h2>
    <p>This project is licensed under the terms of the <a href="https://www.gnu.org/licenses/gpl-3.0.en.html">GNU
        General Public License</a>.</p>

</body>

</html>